//
//  HLImageInfoUtils.m
//  EditImageGPSDemo
//
//  Created by LHL on 17/2/17.
//  Copyright © 2017年 lihongli. All rights reserved.
//

/**
 {
 ColorModel = RGB;
 DPIHeight = 72;
 DPIWidth = 72;
 Depth = 8;
 Orientation = 6;
 PixelHeight = 2448;
 PixelWidth = 3264;
 ProfileName = "sRGB IEC61966-2.1";
 "{Exif}" =     {
 ApertureValue = "2.275007124536905";
 BrightnessValue = "2.341164953499755";
 ColorSpace = 1;
 ComponentsConfiguration =         (
 1,
 2,
 3,
 0
 );
 DateTimeDigitized = "2017:02:17 11:25:07";
 DateTimeOriginal = "2017:02:17 11:25:07";
 ExifVersion =         (
 2,
 2,
 1
 );
 ExposureBiasValue = 0;
 ExposureMode = 0;
 ExposureProgram = 2;
 ExposureTime = "0.0303030303030303";
 FNumber = "2.2";
 Flash = 24;
 FlashPixVersion =         (
 1,
 0
 );
 FocalLenIn35mmFilm = 29;
 FocalLength = "4.15";
 ISOSpeedRatings =         (
 160
 );
 LensMake = Apple;
 LensModel = "iPhone 5s back camera 4.15mm f/2.2";
 LensSpecification =         (
 "4.15",
 "4.15",
 "2.2",
 "2.2"
 );
 MeteringMode = 5;
 PixelXDimension = 3264;
 PixelYDimension = 2448;
 SceneCaptureType = 0;
 SceneType = 1;
 SensingMethod = 2;
 ShutterSpeedValue = "5.059471365638767";
 SubjectArea =         (
 1631,
 1223,
 1795,
 1077
 );
 SubsecTimeDigitized = 941;
 SubsecTimeOriginal = 941;
 WhiteBalance = 0;
 };
 "{GPS}" =     {
 Altitude = "64.43584905660377";
 AltitudeRef = 0;
 DateStamp = "2017:02:17";
 HPositioningError = 65;
 Latitude = "39.98217";
 LatitudeRef = N;
 Longitude = "116.319625";
 LongitudeRef = E;
 Speed = 0;
 SpeedRef = K;
 TimeStamp = "03:25:03";
 };
 "{MakerApple}" =     {
 1 = 4;
 14 = 1;
 2 = <1a032b03 7303e201 8a014401 ee00d600 f8000a01 f1006c03 ab007800 49004800 6302ce01 e101ce01 3801a100 b500f800 bd009b00 d5006703 79007100 44004300 fc01b201 da01b601 da00aa00 c4000001 d0009700 74007200 5b005a00 44004200 52013d01 39015901 d1000601 f6000701 b5008700 58004500 3f003c00 39003800 73006800 a6005801 b9006601 1301e900 a5008500 ab005700 40003e00 2c002700 71006500 aa008601 bc00ee00 bc000201 88008e00 5f006500 45002d00 29002800 70006600 b4009201 d2009000 bc009400 7c006400 3f003400 42003900 31002f00 6e006600 bc009801 27019c00 cf00a300 d9009900 71006200 6a006a00 6b006300 6b006500 c3009501 7901ed00 a900c800 dd00b200 7a008200 8c009100 87008a00 6a006400 c9008f01 82016801 dc009100 8d006e00 5e009a00 90007d00 8200bc00 69006300 cc008b01 82017f01 71011e01 c9009d00 d000ef00 da00bc00 a400e800 68006200 ce008801 7f017e01 7d017801 5e011f01 10010f01 fd00de00 c300f800 66006100 d1008401 79017a01 7c017a01 68013501 27012601 1a01f800 1901f901 62005f00 d4007c01 73017601 79017901 6b013f01 33013601 31010e01 05014401 5e005d00 d6007601 6f017101 76017701 6d014601 3a013c01 42012f01 c5007b00 5b005c00 d8007301 6a016d01 73017501 6f014c01 3d013e01 45013a01 0401c500>;
 20 = 4;
 3 =         {
 epoch = 0;
 flags = 1;
 timescale = 1000000000;
 value = 3609369126500;
 };
 4 = 1;
 5 = 214;
 6 = 217;
 7 = 1;
 8 =         (
 "-0.01507195",
 "-0.929393",
 "-0.3721918"
 );
 9 = 275;
 };
 "{TIFF}" =     {
 DateTime = "2017:02:17 11:25:07";
 Make = Apple;
 Model = "iPhone 5s";
 Orientation = 6;
 ResolutionUnit = 2;
 Software = "10.1";
 XResolution = 72;
 YResolution = 72;
 };
 }
 2017-02-17 17:55:09.038577 EditImageGPSDemo[999:92359] [Generic] Creating an image format with an unknown type is an error
 2017-02-17 17:55:11.423306 EditImageGPSDemo[999:92359] image property: {
 ColorModel = RGB;
 DPIHeight = 72;
 DPIWidth = 72;
 Depth = 8;
 Orientation = 6;
 PixelHeight = 2448;
 PixelWidth = 3264;
 ProfileName = "sRGB IEC61966-2.1";
 "{Exif}" =     {
 ApertureValue = "2.275007124536905";
 BrightnessValue = "4.538476300134331";
 ColorSpace = 1;
 ComponentsConfiguration =         (
 1,
 2,
 3,
 0
 );
 DateTimeDigitized = "2016:08:16 17:16:22";
 DateTimeOriginal = "2016:08:16 17:16:22";
 ExifVersion =         (
 2,
 2,
 1
 );
 ExposureBiasValue = 0;
 ExposureMode = 0;
 ExposureProgram = 2;
 ExposureTime = "0.025";
 FNumber = "2.2";
 Flash = 24;
 FlashPixVersion =         (
 1,
 0
 );
 FocalLenIn35mmFilm = 29;
 FocalLength = "4.15";
 ISOSpeedRatings =         (
 40
 );
 LensMake = Apple;
 LensModel = "iPhone 5s back camera 4.15mm f/2.2";
 LensSpecification =         (
 "4.15",
 "4.15",
 "2.2",
 "2.2"
 );
 MeteringMode = 5;
 PixelXDimension = 3264;
 PixelYDimension = 2448;
 SceneCaptureType = 0;
 SceneType = 1;
 SensingMethod = 2;
 ShutterSpeedValue = "5.322505800464037";
 SubjectArea =         (
 1631,
 1223,
 1795,
 1077
 );
 SubsecTimeDigitized = 944;
 SubsecTimeOriginal = 944;
 WhiteBalance = 0;
 };
 "{GPS}" =     {
 Altitude = "63.69697953881131";
 AltitudeRef = 0;
 DateStamp = "2016:08:16";
 Latitude = "39.98222166666667";
 LatitudeRef = N;
 Longitude = "116.3195883333333";
 LongitudeRef = E;
 Speed = 0;
 SpeedRef = K;
 TimeStamp = "09:16:18";
 };
 "{MakerApple}" =     {
 1 = 2;
 14 = 1;
 2 = <1a001b00 1c007600 de00d000 b800da00 fa000f01 23012d01 32013801 3e014901 11001100 14008700 e000e400 da00c300 ea00f900 20012b01 2a012e01 31013e01 27001a00 1500aa00 e100df00 df00b900 ec00f600 17011d01 1d011d01 21013001 29001b00 1c00bd00 c800b200 d300b900 fe000801 fd000301 04010501 10011b01 2f002500 3e00b400 82007000 77008f00 af00b800 cf00e700 e400f300 0a01f500 32002900 7b00b400 bf008400 7e007f00 71005c00 7400c300 d700eb00 0801f500 39002900 b300de00 95006b00 7a008100 81007300 6900b100 d400e400 f600fc00 81005100 ae00a400 b7007600 7f007e00 75005800 5300a900 cd00dd00 e300fd00 2b013001 fc000001 cb007800 8a008a00 86006b00 7400ad00 e5000201 10015001 40014701 c200bc00 a1007600 8a008900 8e005e00 7200c100 05013301 1e015601 49014801 00013301 48011701 21010a01 d600f600 5301ac01 48013901 6a018501 4e013601 e400d300 c4000001 bf00a700 74002401 71016e01 35018501 cd01aa01 b600ae00 f500db00 ed00d700 e3005400 c9001c01 2b014001 5b01de01 de019c01 b400c100 9c00db00 f600dd00 d6003700 02018601 a701c401 cb016801 b0018301 8600ae00 7100c300 f900f300 b400ac00 59018701 bb01e001 e601b401 41015401 65007a00 7000b100 fd001301 dd00ce00 63018e01 b801db01 c9019b01 83015901>;
 3 =         {
 epoch = 0;
 flags = 1;
 timescale = 1000000000;
 value = 254886268655416;
 };
 4 = 1;
 5 = 215;
 6 = 211;
 7 = 1;
 8 =         (
 "-0.02241449",
 "-0.6921934",
 "-0.7009764"
 );
 9 = 275;
 };
 "{TIFF}" =     {
 DateTime = "2016:08:16 17:16:22";
 Make = Apple;
 Model = "iPhone 5s";
 Orientation = 6;
 ResolutionUnit = 2;
 Software = "8.2";
 XResolution = 72;
 YResolution = 72;
 };
 }
 */

#import "HLImageInfoUtils.h"

#import <AssetsLibrary/ALAsset.h>
#import <AssetsLibrary/ALAssetRepresentation.h>

@interface HLImageInfoUtils()

@property (nonatomic, strong, readwrite) UIImage *image;

@end

@implementation HLImageInfoUtils

- (id)initWithImage:(UIImage*)image
{
    self = [super init];
    if (self) {
        NSData *imageData = nil;
        if (UIImageJPEGRepresentation(image,1) == nil) {
            imageData = UIImagePNGRepresentation(image);
        } else {
            imageData = UIImageJPEGRepresentation(image,1);
        }
        self.image = image;
        self.sourceRef = CGImageSourceCreateWithData((CFDataRef)imageData, NULL);
        self.imageProperty = (NSDictionary*)CFBridgingRelease(CGImageSourceCopyPropertiesAtIndex(self.sourceRef, 0, NULL));
        NSLog(@"image property: %@", self.imageProperty);
    }
    
    return self;
}

- (id)initWithImageURL:(NSURL*)imageUrl
{
    self = [super init];
    if (self) {
        if ([imageUrl.absoluteString hasPrefix:@"assets-library:"]) {
            [self configuretionLibaryImageURL:imageUrl];
        }
        else {
            self.sourceRef = CGImageSourceCreateWithURL((CFURLRef)imageUrl, NULL);
            self.imageProperty = (NSDictionary*)CFBridgingRelease(CGImageSourceCopyPropertiesAtIndex(self.sourceRef, 0, NULL));
            NSLog(@"image property: %@", self.imageProperty);
        }
    }
    
    return self;
}

- (void)configuretionLibaryImageURL:(NSURL *)imageURL{
    ALAssetsLibrary *library = [[ALAssetsLibrary alloc] init];
    __weak typeof(self) mySelf = self;
    [library assetForURL:imageURL
             resultBlock:^(ALAsset *asset) {
                 ALAssetRepresentation *image_representation = [asset defaultRepresentation];
                 uint8_t *buffer = (Byte*)malloc(image_representation.size);
                 NSUInteger length = [image_representation getBytes:buffer fromOffset: 0.0  length:image_representation.size error:nil];
                 
                 if (length != 0)  {
                     // buffer -> NSData object; free buffer afterwards
                     NSData *adata = [[NSData alloc] initWithBytesNoCopy:buffer length:image_representation.size freeWhenDone:YES];
                     
                     // identify image type (jpeg, png, RAW file, ...) using UTI hint
                     NSDictionary* sourceOptionsDict = [NSDictionary dictionaryWithObjectsAndKeys:(id)[image_representation UTI] ,kCGImageSourceTypeIdentifierHint,nil];
                     
                     // create CGImageSource with NSData
                     mySelf.sourceRef = CGImageSourceCreateWithData((__bridge CFDataRef) adata,  (__bridge CFDictionaryRef) sourceOptionsDict);
                     
                     self.imageProperty = (__bridge NSDictionary *)(CGImageSourceCopyPropertiesAtIndex(mySelf.sourceRef,0, NULL));
                     NSLog(@"image property: %@", self.imageProperty);
                 }
                 else {
                     NSLog(@"image_representation buffer length == 0");
                 }
             } failureBlock:^(NSError *error) {
                 
             }];
}

- (void)save{
    CFStringRef imagUTI = CGImageSourceGetType(self.sourceRef);
    NSString *tempImagePath = [NSString stringWithFormat:@"%@/Documents/DSC02040.JPG", NSHomeDirectory()];
    NSURL *newFileUrl = [[NSURL alloc] initFileURLWithPath:tempImagePath];
    NSLog(@"存储路径 %@", NSHomeDirectory());
    CGImageDestinationRef imageDestination = CGImageDestinationCreateWithURL((CFURLRef)newFileUrl, imagUTI, 1, NULL);
    CGImageDestinationAddImageFromSource(imageDestination, self.sourceRef, 0, (CFDictionaryRef)self.imageProperty);
    CGImageDestinationFinalize(imageDestination);
    
    UIImageWriteToSavedPhotosAlbum([UIImage imageWithContentsOfFile:tempImagePath], nil, nil, nil);
}

#pragma mark -- 

- (void)setLocation2D:(CLLocationCoordinate2D)location2D{
    NSNumber *latitude = @(location2D.latitude);
    NSNumber *longitude = @(location2D.longitude);
    [self.gpsDictonary setValue:latitude forKey:(NSString *)kCGImagePropertyGPSLatitude];
    [self.gpsDictonary setValue:longitude forKey:(NSString *)kCGImagePropertyGPSLongitude];
}

- (CLLocationCoordinate2D)location2D{
    CLLocationDegrees latitude = [[self.gpsDictonary valueForKey:(NSString *)kCGImagePropertyGPSLatitude] doubleValue];
    CLLocationDegrees longitude = [[self.gpsDictonary valueForKey:(NSString *)kCGImagePropertyGPSLatitude] doubleValue];
    return CLLocationCoordinate2DMake(latitude, longitude);
}

- (NSInteger)pixelHeight{
    return (NSInteger)[_imageProperty valueForKey:(NSString*)kCGImagePropertyPixelHeight];
}

- (NSInteger)pixelWidth{
    return (NSInteger)[_imageProperty valueForKey:(NSString*)kCGImagePropertyPixelWidth];
}

- (NSString *)dataTime{
    return [self.tiffDictonary valueForKey:(NSString*)kCGImagePropertyTIFFDateTime];
}

- (NSDictionary *)gpsDictonary{
    return [_imageProperty valueForKey:(NSString*)kCGImagePropertyGPSDictionary];
}

- (NSDictionary *)tiffDictonary{
    return [_imageProperty valueForKey:(NSString*)kCGImagePropertyTIFFDictionary];

}

- (NSDictionary *)exifDictonary{
    return [_imageProperty valueForKey:(NSString*)kCGImagePropertyExifDictionary];
}

@end
